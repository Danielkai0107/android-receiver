# 📱 SafeNet Android 接收器 - 使用說明

## 🎯 核心理念

**即裝即用，無需預先配置**

這個 App 設計為可以直接安裝使用，不需要在後台預先註冊 Gateway。所有配置都是可選的，用於增強功能。

---

## 🚀 兩種使用模式

### 模式 1: 基礎模式（即裝即用）

**特點**:
- ✅ 無需預先配置
- ✅ 安裝即可使用
- ✅ 掃描所有 Beacon
- ✅ 上傳所有數據

**使用步驟**:
1. 安裝 App
2. 授予權限
3. 點擊「開始掃描」
4. 完成！

**適用場景**:
- 快速部署
- 開發測試
- 不確定要監控哪些設備
- 需要收集所有 Beacon 數據

### 模式 2: 白名單模式（可選配置）

**特點**:
- ✅ 精確監控
- ✅ 節省流量
- ✅ 減少處理
- ✅ 提高效率

**使用步驟**:
1. 在 Firebase 註冊 Gateway
2. 添加需要監控的設備
3. 安裝 App
4. 授予權限
5. 同步白名單
6. 點擊「開始掃描」

**適用場景**:
- 生產環境
- 只需監控特定設備
- 需要節省流量
- 設備數量多但只關注部分

---

## 📋 詳細操作流程

### 步驟 1: 安裝 App

**方法 A: 使用測試腳本**
```bash
cd /Users/danielkai/Desktop/safe-net-app/android-receiver
./test-device.sh
# 選擇 1) 構建並安裝
```

**方法 B: 使用 Android Studio**
```
1. 打開 Android Studio
2. 打開專案
3. 選擇實體機
4. 點擊 Run
```

### 步驟 2: 授予權限

**必要權限**:
- ✅ **位置權限**（精確位置）- 藍牙掃描必需
- ✅ **藍牙權限** - 掃描 Beacon
- ✅ **讀取手機狀態** - 獲取 IMEI
- ✅ **通知權限** - 前景服務通知

**如何授予**:
- App 首次啟動會自動請求
- 依序點擊「允許」即可

### 步驟 3: 查看 Gateway ID

**Gateway ID 來源**:
1. **首選**: 手機 IMEI
2. **備用**: Android ID（格式: ANDROID-XXXXXXXXX）

**查看位置**:
- 主畫面頂部顯示
- 格式: `Gateway ID: 123456789012345`

**記錄這個 ID**:
- 如需配置白名單模式，會用到
- 用於在 Firebase 中註冊 Gateway

### 步驟 4A: 基礎模式使用

**直接開始掃描**:
1. 點擊「開始掃描」按鈕
2. 通知欄顯示「Beacon 掃描服務運行中」
3. 觀察統計數據更新

**預期行為**:
- 白名單設備: 0（或顯示錯誤，正常）
- 已掃描: 逐漸增加
- 待上傳: 逐漸增加
- 已上傳: 每 60 秒增加一次

### 步驟 4B: 白名單模式使用

**配置白名單**:
1. 記下 Gateway ID
2. 在 Firebase Console 操作：

```javascript
// 在 gateways 集合中添加
{
  "imei": "你的 Gateway ID",
  "type": "mobile",
  "status": "active",
  "tenantId": "your-tenant-id"
}

// 在 devices 集合中添加要監控的設備
{
  "uuid": "FDA50693-A4E2-4FB1-AFCF-C6EB07647825",
  "major": 100,
  "minor": 1,
  "deviceName": "設備-001",
  "macAddress": "AA:BB:CC:DD:EE:FF",
  "isActive": true,
  "tenantId": "your-tenant-id"
}
```

**同步白名單**:
1. 在 App 中點擊「同步白名單」
2. 等待幾秒
3. 查看白名單設備數量更新

**開始掃描**:
1. 點擊「開始掃描」
2. 觀察統計數據
3. 只有白名單中的設備會被上傳

---

## 📊 UI 界面說明

### 主畫面

```
┌─────────────────────────────────┐
│ SafeNet 接收器                   │
├─────────────────────────────────┤
│ Gateway ID: 123456789012345     │
│                                 │
│ 白名單設備: 0                    │
│ 已掃描: 15                       │
│ 已上傳: 10                       │
│ 待上傳: 5                        │
│                                 │
│ [開始掃描] / [停止掃描]          │
│ [同步白名單]                     │
│                                 │
│ 上次同步: 2026-01-20 10:30:00   │
│                                 │
│ [查看白名單]  [設定]             │
└─────────────────────────────────┘
```

**說明**:
- **Gateway ID**: 自動獲取的設備識別碼
- **白名單設備**: 從後台同步的設備數量（可為 0）
- **已掃描**: 掃描到的 Beacon 總數
- **已上傳**: 成功上傳的記錄數
- **待上傳**: 等待上傳的記錄數

### 白名單頁面

```
┌─────────────────────────────────┐
│ 白名單設備                       │
├─────────────────────────────────┤
│ ┌─────────────────────────────┐ │
│ │ 設備-001                    │ │
│ │ UUID: FDA5...7825           │ │
│ │ Major: 100, Minor: 1        │ │
│ │ MAC: AA:BB:CC:DD:EE:FF      │ │
│ │ 同步時間: 2026-01-20 10:30  │ │
│ └─────────────────────────────┘ │
│ ┌─────────────────────────────┐ │
│ │ 設備-002                    │ │
│ │ ...                         │ │
│ └─────────────────────────────┘ │
└─────────────────────────────────┘
```

### 設定頁面

```
┌─────────────────────────────────┐
│ 設定                            │
├─────────────────────────────────┤
│ 掃描頻率                         │
│ 5 秒                            │
│                                 │
│ 上傳間隔                         │
│ 60 秒                           │
│                                 │
│ 白名單同步間隔                    │
│ 10 分鐘                         │
│                                 │
│ GPS 更新頻率                     │
│ 2 分鐘                          │
│                                 │
│ 離線快取上限                     │
│ 1000 筆                         │
└─────────────────────────────────┘
```

**注意**: 當前版本設定為唯讀顯示

---

## 🔍 運行狀態說明

### 正常運行的標誌

**基礎模式**:
- ✅ Gateway ID 顯示正確
- ⚠️ 白名單設備可能為 0（正常）
- ✅ 已掃描數逐漸增加
- ✅ 待上傳數逐漸增加
- ✅ 每 60 秒上傳一次

**白名單模式**:
- ✅ Gateway ID 顯示正確
- ✅ 白名單設備 > 0
- ✅ 只有白名單設備增加掃描數
- ✅ 定期上傳

### 通知欄狀態

**掃描中**:
```
SafeNet 接收器
已掃描: 25 個設備
```

**停止時**:
- 通知消失
- 掃描停止

---

## 💡 使用技巧

### 技巧 1: 查看實時 Log

**了解 App 運行情況**:
```bash
# 查看白名單同步
adb logcat | grep WhitelistRepository

# 查看 Beacon 掃描
adb logcat | grep BeaconScanService

# 查看上傳狀態
adb logcat | grep UploadRepository

# 查看所有相關 Log
adb logcat | grep -i safenet
```

### 技巧 2: 快速切換模式

**從基礎模式切換到白名單模式**:
1. 在 Firebase 配置 Gateway 和設備
2. 點擊「同步白名單」
3. 重啟掃描

**從白名單模式切換到基礎模式**:
1. 清空白名單（在 Firebase 中）
2. 點擊「同步白名單」
3. 會顯示 0 個設備
4. 自動切換為掃描所有 Beacon

### 技巧 3: 測試上傳

**驗證數據是否成功上傳**:
1. 查看「已上傳」數量是否增加
2. 在 Cloud Function Log 中查看
3. 檢查後端數據庫

### 技巧 4: 省電使用

**長時間運行建議**:
- 加入電池優化白名單
- 使用低亮度
- 關閉不必要的功能
- 確保網路穩定

---

## 🐛 常見問題

### Q1: 白名單同步顯示錯誤

**提示**: "Gateway not registered"

**說明**: 這是正常的，不影響使用

**解決**: 
- 方案 A: 繼續使用基礎模式
- 方案 B: 在 Firebase 註冊 Gateway

### Q2: 白名單為 0 是否正常？

**答**: 完全正常！

- 基礎模式下，白名單為 0
- App 會掃描所有 Beacon
- 所有數據都會上傳

### Q3: 待上傳數量一直增加

**原因**: 
- 網路連線問題
- Cloud Function 異常

**解決**:
1. 檢查網路連線
2. 查看 Log 確認錯誤
3. 網路恢復後自動上傳

### Q4: 掃描不到 Beacon

**檢查清單**:
- [ ] 藍牙已開啟
- [ ] 位置權限已授予
- [ ] Beacon 設備正常工作
- [ ] Beacon 在範圍內（< 10m）
- [ ] Beacon 電池充足

### Q5: IMEI 顯示為 ANDROID-XXX

**說明**: 
- Android 10+ 限制 IMEI 訪問
- 自動使用 Android ID 作為備用
- 功能完全正常

---

## 📈 數據流向

### 基礎模式流程

```
手機掃描
   ↓
偵測到 Beacon
   ↓
加入上傳佇列（所有 Beacon）
   ↓
60 秒批次打包
   ↓
上傳到 Cloud Function
   ↓
Cloud Function 處理
   ↓
保存到數據庫
```

### 白名單模式流程

```
手機掃描
   ↓
偵測到 Beacon
   ↓
檢查白名單
   ↓
在白名單中？
   ├─ 是 → 加入上傳佇列
   └─ 否 → 忽略
   ↓
60 秒批次打包
   ↓
上傳到 Cloud Function
   ↓
Cloud Function 處理
   ↓
保存到數據庫
```

---

## 🎯 最佳實踐

### 開發測試階段
1. 使用基礎模式
2. 掃描所有 Beacon
3. 收集完整數據
4. 分析哪些設備需要監控

### 生產部署階段
1. 配置白名單模式
2. 只監控必要設備
3. 節省流量和處理
4. 提高系統效率

### 維護階段
1. 定期檢查 Log
2. 監控上傳狀態
3. 及時更新白名單
4. 優化配置參數

---

## 📞 技術支持

**文檔**:
- `README.md` - 專案說明
- `QUICK_START_GUIDE.md` - 快速開始
- `TESTING.md` - 測試指南
- `IMPORTANT_NOTE.md` - 重要說明

**工具**:
- `test-device.sh` - 測試腳本
- `開始測試.txt` - 快速參考

---

🎉 **祝使用愉快！**
