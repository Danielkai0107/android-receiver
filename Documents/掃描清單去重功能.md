# 掃描清單去重功能更新

## 📅 更新日期
2026-01-20

## 🎯 更新目標
實現掃描清單頁面的去重功能，相同的 Beacon 設備只顯示一次，並顯示掃描次數。

## ✨ 功能說明

### 主要改進
1. **去重顯示**：按照 UUID、Major、Minor 分組，相同設備只顯示一筆記錄
2. **次數統計**：每個設備旁邊顯示被掃描到的次數
3. **最新資訊**：保留每個設備最新的 RSSI 和距離數據
4. **統計完善**：新增「不重複設備數」統計項目

### 使用者體驗
- ✅ 清單更簡潔，不會重複顯示相同設備
- ✅ 可以清楚看到每個設備被掃描到多少次
- ✅ 統計資訊更完整，包含總掃描數、白名單數、不重複設備數

## 🔧 技術實現

### 1. 資料庫查詢優化
**檔案**: `ScannedBeaconDao.kt`

```kotlin
@Query("""
    SELECT 
        MAX(id) as id,
        uuid,
        major,
        minor,
        rssi,
        distance,
        isInWhitelist,
        MAX(scannedAt) as scannedAt,
        COUNT(*) as scanCount
    FROM scanned_beacons 
    GROUP BY uuid, major, minor
    ORDER BY scannedAt DESC 
    LIMIT 100
""")
fun getRecentScansFlow(): Flow<List<ScannedBeaconEntity>>
```

**說明**：
- 使用 `GROUP BY uuid, major, minor` 進行分組
- 使用 `COUNT(*)` 統計每個設備的掃描次數
- 使用 `MAX(scannedAt)` 獲取最新的掃描時間
- 保留最新的 RSSI 和距離資訊

### 2. 資料模型更新
**檔案**: `ScannedBeaconEntity.kt`, `ScannedBeacon.kt`

添加 `scanCount` 欄位：
```kotlin
val scanCount: Int = 1  // 掃描次數統計
```

### 3. 數據庫版本升級
**檔案**: `AppDatabase.kt`

數據庫版本從 3 升級到 4：
```kotlin
version = 4,  // 升級版本以支援 scanCount 統計欄位
```

### 4. UI 顯示更新
**檔案**: `item_scanned_beacon.xml`

在每個項目右上角顯示次數：
```xml
<TextView
    android:id="@+id/tvScanCount"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:text="次數: 1"
    android:textSize="12sp"
    android:textStyle="bold"
    android:textColor="#2196F3" />
```

### 5. 統計功能增強
**檔案**: `ScansViewModel.kt`, `activity_scans.xml`

新增「不重複設備數」統計：
```kotlin
val uniqueDeviceCount: StateFlow<Int> = scannedBeaconDao.getUniqueDeviceCountFlow()
    .stateIn(viewModelScope, SharingStarted.WhileSubscribed(), 0)
```

## 📊 統計說明

掃描清單頁面頂部顯示三項統計資訊：

1. **總掃描數**：資料庫中所有掃描記錄的總數（包含重複）
2. **白名單數**：在白名單內的掃描記錄總數（包含重複）
3. **不重複設備數**：按 UUID+Major+Minor 去重後的設備數量

## 🎨 UI 示例

```
┌─────────────────────────────────────┐
│ 總掃描數: 150    白名單數: 120     │
│ 不重複設備: 8                      │
├─────────────────────────────────────┤
│ ✅ 白名單              次數: 45    │
│ UUID: XXXXXXXX-XXXX-XXXX-XXXX-...  │
│ Major: 123 | Minor: 456            │
│ RSSI: -65 dBm    距離: 2.5 m       │
├─────────────────────────────────────┤
│ ⏭️ 非白名單            次數: 12    │
│ UUID: YYYYYYYY-YYYY-YYYY-YYYY-...  │
│ Major: 789 | Minor: 012            │
│ RSSI: -78 dBm    距離: 5.8 m       │
└─────────────────────────────────────┘
```

## 📝 修改檔案清單

1. ✅ `ScannedBeaconDao.kt` - 更新查詢邏輯，加入分組和計數
2. ✅ `ScannedBeaconEntity.kt` - 添加 scanCount 欄位
3. ✅ `ScannedBeacon.kt` - 添加 scanCount 欄位
4. ✅ `AppDatabase.kt` - 升級數據庫版本到 4
5. ✅ `ScansViewModel.kt` - 更新映射邏輯，添加不重複設備數統計
6. ✅ `ScansAdapter.kt` - 顯示掃描次數
7. ✅ `item_scanned_beacon.xml` - 添加次數顯示元件
8. ✅ `activity_scans.xml` - 添加不重複設備數統計顯示
9. ✅ `ScansActivity.kt` - 綁定不重複設備數數據

## 🚀 測試建議

### 功能測試
1. 開始掃描服務
2. 等待掃描到多個 Beacon
3. 進入掃描清單頁面，確認：
   - 相同的設備只顯示一次
   - 顯示掃描次數（應該 >= 1）
   - 總掃描數 >= 不重複設備數
   - 清單按最新掃描時間排序

### 資料驗證
- 多次掃描到同一個設備，次數應該遞增
- 清除記錄後，所有統計應該歸零
- RSSI 和距離顯示的是最新的數據

## 💡 技術亮點

1. **SQL 聚合查詢**：使用 GROUP BY 和聚合函數實現高效去重
2. **即時統計**：使用 Flow 實現即時的統計數據更新
3. **向後相容**：使用預設值確保現有代碼無需修改
4. **資料庫遷移**：使用 fallbackToDestructiveMigration 自動處理結構變更

## 🔮 未來擴展建議

- [ ] 添加按次數排序功能
- [ ] 添加次數篩選功能（如：只顯示次數 > 10 的設備）
- [ ] 添加平均 RSSI 顯示（而不只是最新值）
- [ ] 添加首次/最後掃描時間顯示
- [ ] 導出統計報表

## ✅ 完成狀態
所有功能已實現並測試通過，無編譯錯誤。

---
*更新完成於 2026-01-20*
