# ✅ 雙重上傳端點實作完成

## 🎯 功能概述

實現了**主要端點 + 備用端點**的雙重上傳架構，提高上傳成功率和系統可靠性。

### 上傳策略
1. **優先使用主要端點** (Cloud Functions)
2. **主要失敗時自動切換到備用端點** (Cloud Run)
3. **詳細日誌記錄**，便於調試和監控

---

## 📡 端點配置

### 主要端點 (Primary)
- **類型**: Google Cloud Functions
- **URL**: `https://us-central1-safe-net-tw.cloudfunctions.net/receiveBeaconData`
- **方法**: `POST`
- **優先級**: 🥇 第一優先

### 備用端點 (Fallback)
- **類型**: Google Cloud Run
- **URL**: `https://receivebeacondata-kmzfyt3t5a-uc.a.run.app/`
- **方法**: `POST`
- **優先級**: 🥈 當主要端點失敗時使用

---

## 🔧 實作細節

### 1. 新增的檔案

#### `app/src/main/java/com/safenet/receiver/data/remote/api/UploadApi.kt`
```kotlin
// 主要上傳 API (Cloud Functions)
interface UploadApi {
    @POST("receiveBeaconData")
    suspend fun uploadBeaconData(@Body request: BeaconDataRequest): BeaconDataResponse
}

// 備用上傳 API (Cloud Run)
interface FallbackUploadApi {
    @POST("/")
    suspend fun uploadBeaconData(@Body request: BeaconDataRequest): BeaconDataResponse
}
```

### 2. 修改的檔案

#### `NetworkModule.kt`
新增了兩個 Qualifier 註解和對應的 Retrofit 實例：
- `@PrimaryUploadRetrofit` → Cloud Functions
- `@FallbackUploadRetrofit` → Cloud Run

#### `UploadRepository.kt`
實現了智能重試邏輯：
```kotlin
suspend fun uploadBeacons(...): Result<Unit> {
    // 1. 先嘗試主要端點
    val primaryResult = tryUploadToPrimary(request)
    if (primaryResult.isSuccess) return primaryResult
    
    // 2. 主要失敗，嘗試備用端點
    val fallbackResult = tryUploadToFallback(request)
    return fallbackResult
}
```

---

## 📊 上傳流程圖

```
開始上傳
    ↓
檢查網路連線
    ↓
準備資料 (去重、格式化)
    ↓
嘗試主要端點 (Cloud Functions)
    ↓
    ├─ 成功 → ✅ 返回成功
    │
    └─ 失敗 → 記錄錯誤
              ↓
         嘗試備用端點 (Cloud Run)
              ↓
              ├─ 成功 → ✅ 返回成功
              │
              └─ 失敗 → ❌ 返回失敗
                        (記錄兩個端點的錯誤)
```

---

## 📝 日誌輸出示例

### 情況 1: 主要端點成功
```
D  上傳 Beacon 資料: gateway=ANDROID-xxx, count=3
D  嘗試主要端點 (Cloud Functions)...
D  主要端點 上傳成功
D  ✅ 主要端點上傳成功
D  ✅ 上傳成功: 3 筆，已更新狀態為 UPLOADED
```

### 情況 2: 主要失敗，備用成功
```
D  上傳 Beacon 資料: gateway=ANDROID-xxx, count=3
D  嘗試主要端點 (Cloud Functions)...
E  主要端點 失敗 (HTTP 404): Function not found
W  主要端點失敗: Function not found
D  嘗試備用端點 (Cloud Run)...
D  備用端點 上傳成功
D  ✅ 備用端點上傳成功
D  ✅ 上傳成功: 3 筆，已更新狀態為 UPLOADED
```

### 情況 3: 兩個端點都失敗
```
D  上傳 Beacon 資料: gateway=ANDROID-xxx, count=3
D  嘗試主要端點 (Cloud Functions)...
E  主要端點 失敗 (HTTP 404): Function not found
W  主要端點失敗: Function not found
D  嘗試備用端點 (Cloud Run)...
E  備用端點 失敗 (HTTP 404): Gateway not registered
E  ❌ 所有端點都失敗
E    - 主要端點: Function not found
E    - 備用端點: Gateway not registered
E  ❌ 上傳失敗: Gateway not registered
```

---

## 🧪 測試方法

### 方法 1: 使用測試腳本
```bash
cd /Users/danielkai/Desktop/android-receiver
./test-dual-endpoint.sh
```

### 方法 2: 手動測試
```bash
# 1. 安裝新版本
adb install app/build/outputs/apk/debug/app-debug.apk

# 2. 啟動應用並開始掃描

# 3. 監控上傳日誌
adb logcat | grep -E "UploadRepository|BeaconScanService.*上傳"
```

### 測試重點
- ✅ 觀察是否優先使用主要端點
- ✅ 主要端點失敗時是否自動切換到備用端點
- ✅ 日誌是否清楚顯示使用了哪個端點
- ✅ 兩個端點都失敗時錯誤訊息是否完整

---

## 💡 優勢與特點

### 1. 高可靠性
- 雙重保障，降低上傳失敗率
- 自動容錯切換，無需人工介入

### 2. 靈活性
- 可以獨立更新任一端點
- 便於 A/B 測試和逐步遷移

### 3. 可維護性
- 清晰的日誌記錄
- 獨立的 API 接口，易於擴展
- 符合單一職責原則

### 4. 性能優化
- 優先使用更快的端點（可根據實際情況調整）
- 失敗後立即重試，無需等待下個週期

---

## 📦 APK 資訊

**構建狀態**: ✅ 成功  
**APK 位置**: `/Users/danielkai/Desktop/android-receiver/app/build/outputs/apk/debug/app-debug.apk`  
**版本**: 包含雙重上傳端點功能

---

## 🔄 後續可能的優化

### 1. 智能端點選擇
根據歷史成功率自動調整優先順序：
```kotlin
// 記錄每個端點的成功率
// 動態選擇成功率較高的端點作為主要端點
```

### 2. 並行上傳
同時向兩個端點發送請求，採用最快回應：
```kotlin
// 使用 async/await 並行上傳
// 一旦有一個成功就取消另一個
```

### 3. 指數退避重試
對單一端點實現多次重試，間隔時間遞增：
```kotlin
// 第 1 次: 立即重試
// 第 2 次: 等待 2 秒
// 第 3 次: 等待 4 秒
```

### 4. 端點健康監控
定期檢查端點健康狀態：
```kotlin
// 定期 ping 端點
// 根據健康狀態調整策略
```

---

## ⚙️ 配置選項（未來可擴展）

可以在 `PreferenceManager` 或設定介面中新增：
- 是否啟用備用端點
- 重試次數
- 超時時間
- 優先端點選擇

---

## 🎉 完成

**雙重上傳端點功能已完整實作！** 🚀

### 主要更新
1. ✅ 新增主要端點 (Cloud Functions)
2. ✅ 保留備用端點 (Cloud Run)
3. ✅ 實現自動容錯切換
4. ✅ 詳細日誌記錄
5. ✅ 構建成功，可以立即測試

### 下一步
請安裝新版本 APK 並進行測試，觀察上傳行為是否符合預期！

---

## 📞 測試支援

如果測試過程中遇到問題，請提供以下資訊：
1. 完整的 logcat 日誌（包含 UploadRepository 標籤）
2. 使用的是哪個端點
3. 具體的錯誤訊息

這樣可以更快速地定位和解決問題。
