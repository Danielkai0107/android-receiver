# âœ… å‰å°æœå‹™æ¬Šé™å´©æ½°ä¿®å¾©

## ğŸ› å´©æ½°éŒ¯èª¤

```
FATAL EXCEPTION: main
java.lang.SecurityException: Starting FGS with type location 
requires permissions: android.permission.FOREGROUND_SERVICE_LOCATION
and the app must be in the eligible state to access the foreground only permission
```

## ğŸ¯ å•é¡ŒåŸå› 

**Android 14 (API 34) çš„æ–°é™åˆ¶**ï¼š
- å‰å°æœå‹™é¡å‹ç‚º `location` æ™‚
- å¿…é ˆ**å…ˆæˆäºˆä½ç½®æ¬Šé™**æ‰èƒ½å•Ÿå‹•æœå‹™
- å³ä½¿ Manifest ä¸­å·²è²æ˜æ¬Šé™ï¼Œé‹è¡Œæ™‚ä¹Ÿå¿…é ˆæª¢æŸ¥

---

## ğŸ”§ ä¿®å¾©æ–¹æ¡ˆ

### HomeFragment.kt - æ·»åŠ æ¬Šé™æª¢æŸ¥

**ä¿®æ”¹å‰**:
```kotlin
private fun startScanService() {
    // æª¢æŸ¥ UUID
    if (currentState.serviceUuidCount == 0) {
        Toast.makeText(requireContext(), "è«‹å…ˆåŒæ­¥æœå‹™ UUID", Toast.LENGTH_SHORT).show()
        return@launch
    }
    
    // ç›´æ¥å•Ÿå‹•æœå‹™ âŒ
    requireContext().startForegroundService(intent)
}
```

**ä¿®æ”¹å¾Œ**:
```kotlin
private fun startScanService() {
    // æª¢æŸ¥ UUID
    if (currentState.serviceUuidCount == 0) {
        Toast.makeText(requireContext(), "è«‹å…ˆåŒæ­¥æœå‹™ UUID", Toast.LENGTH_SHORT).show()
        return@launch
    }
    
    // âœ… Android 14+ éœ€è¦æª¢æŸ¥ä½ç½®æ¬Šé™
    if (!currentState.permissions.location) {
        Toast.makeText(requireContext(), "éœ€è¦ä½ç½®æ¬Šé™æ‰èƒ½å•Ÿå‹•æƒææœå‹™", Toast.LENGTH_LONG).show()
        Log.e("HomeFragment", "ç¼ºå°‘ä½ç½®æ¬Šé™ï¼Œç„¡æ³•å•Ÿå‹•å‰å°æœå‹™")
        return@launch
    }
    
    // æ¬Šé™æª¢æŸ¥é€šéï¼Œå•Ÿå‹•æœå‹™
    requireContext().startForegroundService(intent)
}
```

---

## ğŸ“‹ AndroidManifest.xml æ¬Šé™é…ç½®

**å·²æ­£ç¢ºé…ç½®**:
```xml
<!-- ä½ç½®æ¬Šé™ -->
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />

<!-- å‰å°æœå‹™æ¬Šé™ -->
<uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
<uses-permission android:name="android.permission.FOREGROUND_SERVICE_LOCATION" />

<!-- æœå‹™è²æ˜ -->
<service
    android:name=".service.BeaconScanService"
    android:foregroundServiceType="location" />
```

---

## ğŸ”„ å®Œæ•´çš„å•Ÿå‹•æª¢æŸ¥æµç¨‹

```
ã€ç”¨æˆ¶é»ã€Œé–‹å§‹æƒæã€ã€‘
  â†“
æª¢æŸ¥ 1: Service UUID æ˜¯å¦å·²åŒæ­¥ï¼Ÿ
  â”œâ”€ âŒ å¦ â†’ Toast: "è«‹å…ˆåŒæ­¥æœå‹™ UUID"
  â””â”€ âœ… æ˜¯ â†’ ç¹¼çºŒ
       â†“
æª¢æŸ¥ 2: ä½ç½®æ¬Šé™æ˜¯å¦å·²æˆäºˆï¼Ÿ
  â”œâ”€ âŒ å¦ â†’ Toast: "éœ€è¦ä½ç½®æ¬Šé™æ‰èƒ½å•Ÿå‹•æƒææœå‹™"
  â””â”€ âœ… æ˜¯ â†’ å•Ÿå‹•æœå‹™
       â†“
     ã€æœå‹™å•Ÿå‹•æˆåŠŸã€‘
```

---

## ğŸ“± ç”¨æˆ¶é«”é©—

### å ´æ™¯ 1: ç¼ºå°‘ä½ç½®æ¬Šé™

```
ç”¨æˆ¶é»ã€Œé–‹å§‹æƒæã€
  â†“
Toast: "éœ€è¦ä½ç½®æ¬Šé™æ‰èƒ½å•Ÿå‹•æƒææœå‹™"
  â†“
ç”¨æˆ¶åˆ‡æ›åˆ°ã€Œæ¬Šé™ã€åˆ†é 
  â†“
æˆäºˆä½ç½®æ¬Šé™
  â†“
å›åˆ°åŸ·è¡Œé é¢
  â†“
å†æ¬¡é»ã€Œé–‹å§‹æƒæã€
  â†“
âœ… æˆåŠŸå•Ÿå‹•
```

### å ´æ™¯ 2: å·²æœ‰æ‰€æœ‰æ¬Šé™

```
ç”¨æˆ¶é»ã€Œé–‹å§‹æƒæã€
  â†“
âœ… ç›´æ¥å•Ÿå‹•ï¼ˆç„¡æç¤ºï¼‰
  â†“
Toast: "æƒææœå‹™å·²å•Ÿå‹•"
```

---

## ğŸ“¦ æ–°ç‰ˆæœ¬å·²æ§‹å»º

âœ… **æ§‹å»ºæˆåŠŸï¼**

**APK ä½ç½®**:
```
/Users/danielkai/Desktop/android-receiver/app/build/outputs/apk/debug/app-debug.apk
```

---

## ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ

### 1. æ¸…ç†ä¸¦å®‰è£
```bash
adb shell am force-stop com.safenet.receiver
adb shell pm clear com.safenet.receiver
adb install /Users/danielkai/Desktop/android-receiver/app/build/outputs/apk/debug/app-debug.apk
```

### 2. æ¸¬è©¦æ¬Šé™æª¢æŸ¥

**æ­¥é©Ÿ A: æœªæˆäºˆä½ç½®æ¬Šé™**
1. æ‰“é–‹ App
2. **ä¸è¦**æˆäºˆä½ç½®æ¬Šé™
3. é»æ“Šã€Œé–‹å§‹æƒæã€
4. é æœŸï¼šToast "éœ€è¦ä½ç½®æ¬Šé™æ‰èƒ½å•Ÿå‹•æƒææœå‹™"

**æ­¥é©Ÿ B: å·²æˆäºˆä½ç½®æ¬Šé™**
1. åˆ‡æ›åˆ°ã€Œæ¬Šé™ã€åˆ†é 
2. æˆäºˆæ‰€æœ‰æ¬Šé™
3. å›åˆ°åŸ·è¡Œé é¢
4. é»æ“Šã€Œé–‹å§‹æƒæã€
5. é æœŸï¼šâœ… æœå‹™æˆåŠŸå•Ÿå‹•

### 3. ç›£æ§ Logcat
```bash
adb logcat | grep "HomeFragment\|BeaconScanService"
```

**é æœŸè¼¸å‡ºï¼ˆæ¬Šé™ä¸è¶³æ™‚ï¼‰**:
```
E/HomeFragment: ç¼ºå°‘ä½ç½®æ¬Šé™ï¼Œç„¡æ³•å•Ÿå‹•å‰å°æœå‹™
```

**é æœŸè¼¸å‡ºï¼ˆæ¬Šé™è¶³å¤ æ™‚ï¼‰**:
```
D/HomeFragment: æœå‹™å·²æˆåŠŸå•Ÿå‹•
D/BeaconScanService: æœå‹™å‰µå»º
D/BeaconScanService: æƒæåƒæ•¸ï¼šæƒæ 1.1 ç§’ï¼Œé–“éš” 5 ç§’
D/BeaconScanService: æœå‹™å•Ÿå‹•
```

---

## ğŸ›¡ï¸ Android 14 å‰å°æœå‹™é™åˆ¶

### æ–°çš„è¦æ±‚

| å‰å°æœå‹™é¡å‹ | å¿…éœ€çš„æ¬Šé™ | é‹è¡Œæ™‚æª¢æŸ¥ |
|-------------|-----------|----------|
| location | FOREGROUND_SERVICE_LOCATION + ACCESS_FINE_LOCATION | âœ… å¿…é ˆ |
| camera | FOREGROUND_SERVICE_CAMERA + CAMERA | âœ… å¿…é ˆ |
| microphone | FOREGROUND_SERVICE_MICROPHONE + RECORD_AUDIO | âœ… å¿…é ˆ |
| dataSync | FOREGROUND_SERVICE_DATA_SYNC | âŒ ä¸éœ€è¦ |

### æˆ‘å€‘çš„é…ç½®

```xml
<!-- Manifest è²æ˜ -->
<uses-permission android:name="android.permission.FOREGROUND_SERVICE_LOCATION" />
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />

<service
    android:name=".service.BeaconScanService"
    android:foregroundServiceType="location" />
```

```kotlin
// é‹è¡Œæ™‚æª¢æŸ¥
if (!permissions.location) {
    Toast.makeText("éœ€è¦ä½ç½®æ¬Šé™æ‰èƒ½å•Ÿå‹•æƒææœå‹™")
    return
}
```

---

## âœ… é©—è­‰æ¸…å–®

å®‰è£æ–°ç‰ˆæœ¬å¾Œç¢ºèªï¼š

- [ ] æœªæˆäºˆä½ç½®æ¬Šé™æ™‚ï¼Œé»ã€Œé–‹å§‹æƒæã€æœƒæç¤º
- [ ] æˆäºˆä½ç½®æ¬Šé™å¾Œï¼Œå¯ä»¥æ­£å¸¸å•Ÿå‹•æœå‹™
- [ ] ä¸æœƒå†å‡ºç¾ SecurityException å´©æ½°
- [ ] Logcat æ²’æœ‰ FATAL EXCEPTION

---

## ğŸ‰ å®Œæˆ

**å‰å°æœå‹™æ¬Šé™å´©æ½°å·²ä¿®å¾©ï¼** ğŸš€

### ä¿®å¾©å…§å®¹
âœ… å•Ÿå‹•å‰æª¢æŸ¥ä½ç½®æ¬Šé™  
âœ… æ¬Šé™ä¸è¶³æ™‚å‹å¥½æç¤º  
âœ… é¿å… SecurityException å´©æ½°  
âœ… ç¬¦åˆ Android 14 è¦ç¯„  

---

## ğŸ“± å®‰è£æ¸¬è©¦

```bash
# æ¸…ç†èˆŠæ•¸æ“š
adb shell pm clear com.safenet.receiver

# å®‰è£æ–°ç‰ˆæœ¬
adb install /Users/danielkai/Desktop/android-receiver/app/build/outputs/apk/debug/app-debug.apk

# æ¸¬è©¦ï¼š
# 1. ä¸æˆäºˆæ¬Šé™ â†’ æ‡‰è©²æç¤ºéœ€è¦æ¬Šé™
# 2. æˆäºˆæ¬Šé™ â†’ æ‡‰è©²æ­£å¸¸å•Ÿå‹•
```

**ç¾åœ¨ä¸æœƒå´©æ½°äº†ï¼** âœ¨
